<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­æ“ä½œè­‰å±†æœŸæ›è­‰å­¸ç§‘æ¸¬é©—</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --correct-color: #27ae60;
            --wrong-color: #c0392b;
            --bg-color: #f4f7f6;
            --star-color: #f1c40f;
            --review-color: #8e44ad;
            --browse-color: #16a085;
        }
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px;
            display: flex; justify-content: center;
            min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 600px;
            background: white; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 25px; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }
        
        .progress-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px; background-color: #eee;
        }
        .progress-bar {
            height: 100%; background-color: var(--accent-color); width: 0%; transition: width 0.3s;
        }

        h1 { color: var(--primary-color); text-align: center; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; font-size: 1.5rem; margin-top: 10px; }
        
        .welcome-screen { text-align: center; padding: 20px 0; }
        .mode-btn {
            display: block; width: 100%; padding: 20px; margin: 15px 0;
            border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer;
            transition: transform 0.2s; font-weight: bold; color: white; text-align: left;
            position: relative;
        }
        .mode-btn span.icon { float: right; font-size: 1.5rem; }
        
        .mode-practice { background-color: var(--accent-color); }
        .mode-exam { background-color: #e67e22; }
        .mode-review { background-color: var(--review-color); } 
        .mode-browse { background-color: var(--browse-color); }
        
        .mode-btn:hover { transform: scale(1.02); opacity: 0.95; }
        .mode-desc { font-size: 0.9rem; font-weight: normal; display: block; margin-top: 5px; opacity: 0.9; }

        /* æœ¬åœ°å„²å­˜æç¤ºæ¡†æ¨£å¼ */
        .local-storage-notice {
            background-color: #fff8e1;
            border-left: 4px solid #ffca28;
            padding: 12px 15px;
            margin: 20px 0 10px 0;
            font-size: 0.85rem;
            color: #555;
            text-align: left;
            border-radius: 4px;
            line-height: 1.5;
        }

        .stats-bar { display: flex; justify-content: space-between; margin-bottom: 15px; color: #7f8c8d; font-weight: bold; align-items: center; }
        .timer-badge { background: #e74c3c; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; display: none; }
        
        .question-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 20px; }
        .question-box { font-size: 1.2rem; font-weight: bold; color: #2c3e50; line-height: 1.5; flex-grow: 1; }
        
        .star-btn {
            background: none; border: none; font-size: 2rem; cursor: pointer; color: #ccc; transition: color 0.2s; padding: 0; line-height: 1;
        }
        .star-btn.active { color: var(--star-color); }

        .options-grid { display: flex; flex-direction: column; gap: 12px; }
        .option-btn {
            background: white; border: 2px solid #bdc3c7; border-radius: 10px;
            padding: 15px; text-align: left; font-size: 1rem; cursor: pointer;
            transition: all 0.2s; color: #34495e; position: relative;
        }
        .option-btn:hover { border-color: var(--accent-color); background-color: #ebf5fb; }
        .option-btn.correct { background-color: #d4efdf; border-color: var(--correct-color); color: var(--correct-color); }
        .option-btn.wrong { background-color: #fadbd8; border-color: var(--wrong-color); color: var(--wrong-color); }
        .option-btn.selected { background-color: #ebf5fb; border-color: var(--accent-color); color: var(--primary-color); border-width: 3px; }
        .option-btn.disabled { pointer-events: none; }

        .next-btn {
            margin-top: 25px; background-color: var(--accent-color); color: white;
            border: none; padding: 15px; border-radius: 10px; font-size: 1.1rem;
            cursor: pointer; width: 100%; display: none;
        }

        .result-screen { text-align: center; display: none; }
        .score-circle {
            width: 150px; height: 150px; background: var(--accent-color); border-radius: 50%;
            color: white; display: flex; justify-content: center; align-items: center;
            font-size: 3rem; margin: 0 auto 20px auto; font-weight: bold;
        }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .action-btn { border: none; padding: 12px 25px; border-radius: 8px; font-size: 1rem; cursor: pointer; color: white; }
        .btn-restart { background-color: var(--primary-color); }
        .btn-home { background-color: #95a5a6; }
        .btn-clear-star { background-color: #e74c3c; }
        .btn-toggle-all { background-color: var(--browse-color); }

        .review-section { margin-top: 30px; text-align: left; border-top: 2px solid #eee; padding-top: 20px; }
        .review-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .tab-btn {
            padding: 10px 15px; cursor: pointer; border: none; background: none; font-size: 1rem; color: #7f8c8d; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: bold; }
        
        .list-screen { display: none; }
        .list-item { border-bottom: 1px solid #eee; padding: 20px 0; }
        .list-item:last-child { border-bottom: none; }
        
        .list-q-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .list-q-text { font-weight: bold; color: #2c3e50; font-size: 1.1rem; line-height: 1.4; flex-grow: 1;}
        
        .list-star-btn { font-size: 1.5rem; cursor: pointer; color: #ccc; border: none; background: none; margin-left: 10px; }
        .list-star-btn.active { color: var(--star-color); }

        .list-opt { margin: 5px 0; padding: 8px; border-radius: 5px; color: #555; transition: all 0.3s; border: 1px solid transparent; }
        
        .list-item.revealed .list-opt.is-ans { 
            background-color: #d4efdf; color: #27ae60; font-weight: bold; border-color: #27ae60;
        }
        
        .toggle-ans-btn {
            background-color: #f0f0f0; color: #333; border: 1px solid #ccc; 
            padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.85rem; margin-top: 5px; transition: 0.2s;
        }
        .toggle-ans-btn:hover { background-color: #e0e0e0; }
        .list-item.revealed .toggle-ans-btn {
            background-color: #2c3e50; color: white; border-color: #2c3e50;
        }

        .search-container { margin-bottom: 15px; position: relative; }
        .search-input { 
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; 
        }
        .search-input:focus { border-color: var(--accent-color); outline: none; }

        .review-card { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; font-size: 0.95rem; }
        .review-card.is-star { border-left: 5px solid var(--star-color); }
        .review-card.is-wrong { border-left: 5px solid var(--wrong-color); }
        .ans-wrong { color: var(--wrong-color); text-decoration: line-through; margin-right: 10px;}
        .ans-correct { color: var(--correct-color); font-weight: bold; }

        .footer-info { margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; font-size: 0.8rem; color: #95a5a6; }
        .footer-info a { color: var(--accent-color); text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="progress-container" id="progress-container" style="display:none;">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div id="loading-msg" style="text-align:center;">æ­£åœ¨è¼‰å…¥é¡Œåº«...</div>

    <div id="welcome-screen" class="welcome-screen" style="display:none;">
        <h1>å°ˆæ¥­æ“ä½œè­‰<br>å­¸ç§‘æ¨¡æ“¬æ¸¬é©—</h1>
        <p style="color:#7f8c8d; margin-bottom: 10px;">è«‹é¸æ“‡æ¨¡å¼</p>
        
        <button class="mode-btn mode-practice" onclick="startQuiz('practice')">
            <span class="icon">ğŸ”°</span>
            ç·´ç¿’æ¨¡å¼
            <span class="mode-desc">å³æ™‚é¡¯ç¤ºå°éŒ¯ï¼Œé©åˆåˆå­¸ã€‚</span>
        </button>
        
        <button class="mode-btn mode-exam" onclick="startQuiz('exam')">
            <span class="icon">â±ï¸</span>
            æ¨¡æ“¬è€ƒæ¨¡å¼
            <span class="mode-desc">é™æ™‚60åˆ†é˜ï¼Œäº¤å·å¾Œç®—åˆ†ã€‚</span>
        </button>

        <button class="mode-btn mode-review" onclick="openBookmarkScreen()">
            <span class="icon">â­</span>
            è¤‡ç¿’æ”¶è—é¡Œç›®
            <span class="mode-desc">å°ˆæ³¨ç·´ç¿’æ‚¨æ¨™è¨˜çš„é‡é»é¡Œç›®ã€‚</span>
        </button>

        <button class="mode-btn mode-browse" onclick="openBrowseScreen()">
            <span class="icon">ğŸ“–</span>
            ç€è¦½æ‰€æœ‰é¡Œåº«
            <span class="mode-desc">é¡¯ç¤ºæ‰€æœ‰é¡Œç›®ï¼Œå¯ç•¶å–®å­—å¡ç·´ç¿’ã€‚</span>
        </button>

        <div class="local-storage-notice">
            ğŸ’¡ <b>æº«é¦¨æç¤ºï¼š</b><br>
            æœ¬ç³»çµ±çš„ã€Œæ˜Ÿè™Ÿæ”¶è—ã€èˆ‡ã€Œæ˜“éŒ¯é¡Œè¨˜æ†¶ã€åŠŸèƒ½ï¼Œæ˜¯å„²å­˜åœ¨æ‚¨ç•¶å‰ä½¿ç”¨çš„ç€è¦½å™¨ä¸­ã€‚ç‚ºç¢ºä¿æ‚¨çš„è¤‡ç¿’ç´€éŒ„ä¸éºå¤±ï¼Œè«‹ä¿æŒä½¿ç”¨<b>åŒä¸€å°è£ç½®èˆ‡åŒä¸€å€‹ç€è¦½å™¨</b>é€²è¡Œæ¸¬é©—ï¼ˆé–‹å•Ÿç„¡ç—•æ¨¡å¼æˆ–æ¸…é™¤ç€è¦½å™¨è³‡æ–™å°‡æœƒé‡ç½®ç´€éŒ„ï¼‰ã€‚
        </div>
    </div>

    <div id="quiz-interface" style="display:none;">
        <div class="stats-bar">
            <span id="progress-text">é¡Œç›® 1 / 40</span>
            <span id="score-text">ç­”å°é¡Œæ•¸: 0</span>
            <div id="timer-badge" class="timer-badge">60:00</div>
        </div>
        
        <div class="question-header">
            <div class="question-box" id="question-text"></div>
            <button class="star-btn" id="star-btn" onclick="toggleStar()" title="æ”¶è—æ­¤é¡Œ">â˜…</button>
        </div>
        
        <div class="options-grid" id="options-container"></div>
        <button class="next-btn" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
    </div>

    <div id="result-interface" class="result-screen">
        <div class="score-circle" id="final-score">0</div>
        <h2>æ¸¬é©—çµæŸ</h2>
        <p id="result-message"></p>
        
        <div class="btn-group">
            <button class="action-btn btn-restart" onclick="location.reload()">å›åˆ°é¦–é </button>
        </div>

        <div class="review-section" id="review-section" style="display:none;">
            <div class="review-tabs">
                <button class="tab-btn active" onclick="switchTab('wrong')">ç­”éŒ¯é¡Œç›® (<span id="wrong-count">0</span>)</button>
                <button class="tab-btn" onclick="switchTab('star')">æ”¶è—é¡Œç›® (<span id="star-count">0</span>)</button>
            </div>
            <div id="review-list"></div>
        </div>
    </div>

    <div id="bookmark-screen" class="list-screen">
        <h1>â­ æ”¶è—é¡Œç›®æ¸…å–®</h1>

        <div class="local-storage-notice" style="margin-top: 0; margin-bottom: 20px;">
            æ­¤è™•çš„æ”¶è—ç´€éŒ„åƒ…ä¿å­˜åœ¨æ‚¨ç›®å‰çš„ç€è¦½å™¨ä¸­ï¼Œè‹¥æ›´æ›æ‰‹æ©Ÿæˆ–é›»è…¦å°‡ç„¡æ³•åŒæ­¥é¡¯ç¤ºå–”ï¼
        </div>

        <div class="btn-group" style="margin-bottom: 20px;">
            <button class="action-btn btn-home" onclick="location.reload()">å›åˆ°é¦–é </button>
            <button class="action-btn btn-clear-star" onclick="clearBookmarks()">æ¸…ç©ºæ‰€æœ‰æ”¶è—</button>
        </div>
        <div style="text-align:center; color:#7f8c8d; margin-bottom:10px;">
            <button class="toggle-ans-btn" id="toggle-star-all-btn" onclick="toggleAllStarAnswers()">ğŸ‘ï¸ é¡¯ç¤ºå…¨éƒ¨ç­”æ¡ˆ</button>
        </div>
        <div id="bookmark-list-container" style="text-align: left;"></div>
    </div>

    <div id="browse-screen" class="list-screen">
        <h1>ğŸ“– å®Œæ•´é¡Œåº«ç€è¦½</h1>
        <div class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="ğŸ” è¼¸å…¥é—œéµå­—æœå°‹ (ä¾‹å¦‚ï¼šç½°é°ã€å¹´é½¡...)" oninput="filterBrowseList()">
        </div>
        
        <div class="btn-group" style="margin-bottom: 15px;">
            <button class="action-btn btn-home" onclick="location.reload()">å›åˆ°é¦–é </button>
            <button class="action-btn btn-toggle-all" id="toggle-all-btn" onclick="toggleAllBrowseAnswers()">é¡¯ç¤ºå…¨éƒ¨ç­”æ¡ˆ</button>
        </div>

        <div style="text-align:center; color:#7f8c8d; margin-bottom:10px;">
            å…± <span id="browse-total-count">0</span> é¡Œï¼Œé¡¯ç¤ºä¸­ <span id="browse-show-count">0</span> é¡Œ
        </div>
        <div id="browse-list-container" style="text-align: left;"></div>
    </div>

    <div class="footer-info">
        é¡Œåº«ä¾†æºï¼š<a href="https://www.caa.gov.tw/FileAtt.ashx?lang=1&id=29149" target="_blank">å°ˆæ¥­æ“ä½œè­‰å±†æœŸæ›è­‰å­¸ç§‘æ¸¬é©—é¡Œåº«ã€111.7.7æ›´æ–°ã€‘</a>
    </div>
</div>

<script src="questions.js"></script>

<script>
    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let hasAnswered = false;
    let userSelection = null;
    let currentMode = 'practice';
    let timerInterval;
    let examTimeLeft = 3600;
    
    let wrongAnswersList = [];
    let starredList = JSON.parse(localStorage.getItem('drone_starred_v1')) || [];
    let isAllRevealed = false; 
    let isAllStarRevealed = false; 

    if (typeof questionBank === 'undefined') {
        document.getElementById('loading-msg').innerHTML = "<span style='color:red'>éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° questions.js</span>";
    } else {
        document.getElementById('loading-msg').style.display = 'none';
        document.getElementById('welcome-screen').style.display = 'block';
    }

    // --- æ¸¬é©—åŠŸèƒ½ ---
    function startQuiz(mode) {
        currentMode = mode;
        currentQuestions = [...questionBank].sort(() => Math.random() - 0.5).slice(0, 40);
        currentQuestionIndex = 0;
        score = 0;
        wrongAnswersList = [];
        
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('quiz-interface').style.display = 'block';
        document.getElementById('progress-container').style.display = 'block';
        
        if (currentMode === 'exam') {
            document.getElementById('timer-badge').style.display = 'block';
            document.getElementById('score-text').style.display = 'none'; 
            startTimer();
        } else {
            document.getElementById('timer-badge').style.display = 'none';
            document.getElementById('score-text').style.display = 'inline';
        }
        loadQuestion();
    }

    // --- ç€è¦½æ‰€æœ‰é¡Œç›®åŠŸèƒ½ ---
    function openBrowseScreen() {
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('browse-screen').style.display = 'block';
        document.getElementById('browse-total-count').textContent = questionBank.length;
        renderBrowseList();
    }

    function renderBrowseList() {
        const keyword = document.getElementById('search-input').value.toLowerCase();
        const container = document.getElementById('browse-list-container');
        container.innerHTML = '';

        const filteredList = questionBank.filter(q => {
            return q.q.toLowerCase().includes(keyword) || 
                   q.options.some(opt => opt.toLowerCase().includes(keyword));
        });

        document.getElementById('browse-show-count').textContent = filteredList.length;

        if (filteredList.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">æ‰¾ä¸åˆ°ç¬¦åˆçš„é¡Œç›®ã€‚</p>';
            return;
        }

        const displayList = filteredList; 

        displayList.forEach(q => {
            const item = document.createElement('div');
            item.className = 'list-item';
            
            if(isAllRevealed) item.classList.add('revealed');
            
            const isStarred = starredList.includes(q.id);
            
            let optionsHtml = '';
            q.options.forEach((opt, idx) => {
                const isCorrect = (idx === q.a);
                optionsHtml += `<div class="list-opt ${isCorrect ? 'is-ans' : ''}">${opt}</div>`;
            });

            item.innerHTML = `
                <div class="list-q-header">
                    <div class="list-q-text">${q.id}. ${q.q}</div>
                    <button class="list-star-btn ${isStarred ? 'active' : ''}" onclick="toggleBrowseStar(${q.id}, this)">${isStarred ? 'â˜…' : 'â˜†'}</button>
                </div>
                ${optionsHtml}
                <button class="toggle-ans-btn" onclick="toggleOneAns(this)">ğŸ‘ï¸ ${isAllRevealed ? 'éš±è—ç­”æ¡ˆ' : 'é¡¯ç¤ºç­”æ¡ˆ'}</button>
            `;
            container.appendChild(item);
        });
    }

    function toggleOneAns(btn) {
        const item = btn.closest('.list-item');
        item.classList.toggle('revealed');
        const isRevealed = item.classList.contains('revealed');
        btn.innerHTML = isRevealed ? 'ğŸ™ˆ éš±è—ç­”æ¡ˆ' : 'ğŸ‘ï¸ é¡¯ç¤ºç­”æ¡ˆ';
    }

    function toggleAllBrowseAnswers() {
        isAllRevealed = !isAllRevealed;
        const btn = document.getElementById('toggle-all-btn');
        btn.textContent = isAllRevealed ? 'éš±è—å…¨éƒ¨ç­”æ¡ˆ' : 'é¡¯ç¤ºå…¨éƒ¨ç­”æ¡ˆ';
        renderBrowseList();
    }

    function filterBrowseList() {
        renderBrowseList();
    }

    function toggleBrowseStar(id, btn) {
        const index = starredList.indexOf(id);
        if (index === -1) {
            starredList.push(id);
            btn.classList.add('active');
            btn.textContent = 'â˜…';
        } else {
            starredList.splice(index, 1);
            btn.classList.remove('active');
            btn.textContent = 'â˜†';
        }
        localStorage.setItem('drone_starred_v1', JSON.stringify(starredList));
    }

    // --- æ”¶è—è¤‡ç¿’åŠŸèƒ½ ---
    function openBookmarkScreen() {
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('bookmark-screen').style.display = 'block';
        renderBookmarkList();
    }

    function renderBookmarkList() {
        const container = document.getElementById('bookmark-list-container');
        container.innerHTML = '';

        if (starredList.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">ç›®å‰æ²’æœ‰æ”¶è—ä»»ä½•é¡Œç›®ã€‚<br>åœ¨æ¸¬é©—ä¸­é»æ“Šæ˜Ÿæ˜Ÿå³å¯åŠ å…¥æ”¶è—ã€‚</p>';
            return;
        }

        const savedQuestions = questionBank.filter(q => starredList.includes(q.id));

        savedQuestions.forEach(q => {
            const item = document.createElement('div');
            item.className = 'list-item'; 
            if(isAllStarRevealed) item.classList.add('revealed');
            
            let optionsHtml = '';
            q.options.forEach((opt, idx) => {
                const isCorrect = (idx === q.a);
                optionsHtml += `<div class="list-opt ${isCorrect ? 'is-ans' : ''}">${opt}</div>`;
            });

            item.innerHTML = `
                <div class="list-q-header">
                    <div class="list-q-text">${q.id}. ${q.q}</div>
                    <button onclick="removeStar(${q.id}, this)" style="border:none;background:none;cursor:pointer;color:#e74c3c;font-size:0.9rem;">ğŸ—‘ï¸ ç§»é™¤</button>
                </div>
                ${optionsHtml}
                <button class="toggle-ans-btn" onclick="toggleOneAns(this)">ğŸ‘ï¸ ${isAllStarRevealed ? 'éš±è—ç­”æ¡ˆ' : 'é¡¯ç¤ºç­”æ¡ˆ'}</button>
            `;
            container.appendChild(item);
        });
    }

    function toggleAllStarAnswers() {
        isAllStarRevealed = !isAllStarRevealed;
        const btn = document.getElementById('toggle-star-all-btn');
        btn.textContent = isAllStarRevealed ? 'ğŸ™ˆ éš±è—å…¨éƒ¨ç­”æ¡ˆ' : 'ğŸ‘ï¸ é¡¯ç¤ºå…¨éƒ¨ç­”æ¡ˆ';
        renderBookmarkList();
    }

    function removeStar(id, btnElement) {
        const index = starredList.indexOf(id);
        if (index > -1) {
            starredList.splice(index, 1);
            localStorage.setItem('drone_starred_v1', JSON.stringify(starredList));
            renderBookmarkList();
        }
    }

    function clearBookmarks() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ”¶è—é¡Œç›®å—ï¼Ÿ")) {
            starredList = [];
            localStorage.setItem('drone_starred_v1', JSON.stringify(starredList));
            openBookmarkScreen();
        }
    }

    // --- ä¸€èˆ¬æ¸¬é©—é‚è¼¯ ---
    function loadQuestion() {
        hasAnswered = false;
        userSelection = null;
        const qData = currentQuestions[currentQuestionIndex];
        
        document.getElementById('progress-text').textContent = `é¡Œç›® ${currentQuestionIndex + 1} / ${currentQuestions.length}`;
        
        if(currentMode !== 'exam') {
             document.getElementById('score-text').textContent = `ç­”å°é¡Œæ•¸: ${score}`;
        }
        
        document.getElementById('question-text').textContent = `${qData.id}. ${qData.q}`;
        
        const progressPercent = ((currentQuestionIndex) / currentQuestions.length) * 100;
        document.getElementById('progress-bar').style.width = `${progressPercent}%`;

        updateStarIcon(qData.id);

        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        
        qData.options.forEach((opt, index) => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => handleOptionClick(index, btn, qData);
            optionsContainer.appendChild(btn);
        });

        document.getElementById('next-btn').style.display = 'none';
    }

    function handleOptionClick(selectedIndex, btnElement, qData) {
        if (currentMode === 'practice' && hasAnswered) return;

        const allBtns = document.querySelectorAll('.option-btn');

        if (currentMode === 'practice') {
            hasAnswered = true;
            if (selectedIndex === qData.a) {
                score += 1;
                btnElement.classList.add('correct');
            } else {
                btnElement.classList.add('wrong');
                allBtns[qData.a].classList.add('correct');
                recordWrongAnswer(qData, selectedIndex);
            }
            allBtns.forEach(btn => btn.classList.add('disabled'));
            document.getElementById('score-text').textContent = `ç­”å°é¡Œæ•¸: ${score}`;
            document.getElementById('next-btn').textContent = (currentQuestionIndex < currentQuestions.length - 1) ? "ä¸‹ä¸€é¡Œ" : "æŸ¥çœ‹çµæœ";
            document.getElementById('next-btn').style.display = 'block';

        } else {
            allBtns.forEach(btn => btn.classList.remove('selected'));
            btnElement.classList.add('selected');
            userSelection = selectedIndex;
            
            document.getElementById('next-btn').textContent = (currentQuestionIndex < currentQuestions.length - 1) ? "ä¸‹ä¸€é¡Œ" : "äº¤å·";
            document.getElementById('next-btn').style.display = 'block';
        }
    }

    function nextQuestion() {
        if (currentMode === 'exam') {
            const qData = currentQuestions[currentQuestionIndex];
            if (userSelection === qData.a) {
                score += 1;
            } else {
                recordWrongAnswer(qData, userSelection === null ? -1 : userSelection);
            }
        }

        if (currentQuestionIndex < currentQuestions.length - 1) {
            currentQuestionIndex++;
            loadQuestion();
        } else {
            finishExam();
        }
    }

    function recordWrongAnswer(qData, userAnsIndex) {
        wrongAnswersList.push({
            id: qData.id,
            q: qData.q,
            userAns: userAnsIndex === -1 ? "æœªä½œç­”" : qData.options[userAnsIndex],
            correctAns: qData.options[qData.a]
        });
    }

    function finishExam() {
        clearInterval(timerInterval);
        document.getElementById('quiz-interface').style.display = 'none';
        document.getElementById('result-interface').style.display = 'block';
        document.getElementById('progress-bar').style.width = '100%';

        const finalScore = Math.round((score / currentQuestions.length) * 100);
        document.getElementById('final-score').textContent = finalScore;

        let msg = "";
        if (finalScore === 100) msg = "å¤ªå¼·äº†ï¼å®Œç¾å…¨å°ï¼";
        else if (finalScore >= 80) msg = "å¾ˆæ£’ï¼æº–å‚™å¾ˆå……åˆ†ï¼";
        else if (finalScore >= 60) msg = "åŠæ ¼äº†ï¼Œå†æ¥å†å²ï¼";
        else msg = "åŠ æ²¹ï¼Œå»ºè­°å¤šç·´ç¿’éŒ¯é¡Œï¼";
        document.getElementById('result-message').innerHTML = `${msg}<br>ç­”å° ${score} / ${currentQuestions.length} é¡Œ`;

        document.getElementById('wrong-count').textContent = wrongAnswersList.length;
        document.getElementById('star-count').textContent = starredList.length;
        
        document.getElementById('review-section').style.display = 'block';
        switchTab('wrong');
    }

    function toggleStar() {
        const qId = currentQuestions[currentQuestionIndex].id;
        const index = starredList.indexOf(qId);
        const btn = document.getElementById('star-btn');

        if (index === -1) {
            starredList.push(qId);
            btn.classList.add('active');
        } else {
            starredList.splice(index, 1);
            btn.classList.remove('active');
        }
        localStorage.setItem('drone_starred_v1', JSON.stringify(starredList));
    }

    function updateStarIcon(qId) {
        const btn = document.getElementById('star-btn');
        if (starredList.includes(qId)) {
            btn.classList.add('active');
            btn.textContent = 'â˜…';
        } else {
            btn.classList.remove('active');
            btn.textContent = 'â˜†';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        const listDiv = document.getElementById('review-list');
        listDiv.innerHTML = '';

        if (tabName === 'wrong') {
            if(wrongAnswersList.length === 0) {
                listDiv.innerHTML = '<p style="color:#aaa;text-align:center;">å¤ªæ£’äº†ï¼æœ¬æ¬¡æ²’æœ‰ç­”éŒ¯é¡Œç›®ã€‚</p>';
                return;
            }
            wrongAnswersList.forEach(item => {
                const card = document.createElement('div');
                card.className = 'review-card is-wrong';
                card.innerHTML = `
                    <div style="color:#c0392b;font-size:0.8rem;margin-bottom:5px;">âŒ ç­”éŒ¯</div>
                    <div class="review-q-text">${item.id}. ${item.q}</div>
                    <div>æ‚¨çš„ç­”æ¡ˆï¼š<span class="ans-wrong">${item.userAns}</span></div>
                    <div>æ­£ç¢ºç­”æ¡ˆï¼š<span class="ans-correct">${item.correctAns}</span></div>
                `;
                listDiv.appendChild(card);
            });

        } else if (tabName === 'star') {
            if(starredList.length === 0) {
                listDiv.innerHTML = '<p style="color:#aaa;text-align:center;">ç›®å‰æ²’æœ‰æ”¶è—ä»»ä½•é¡Œç›®ã€‚</p>';
                return;
            }
            const starredQuestions = questionBank.filter(q => starredList.includes(q.id));
            starredQuestions.forEach(item => {
                const card = document.createElement('div');
                card.className = 'review-card is-star';
                card.innerHTML = `
                    <div style="color:#f1c40f;font-size:0.8rem;margin-bottom:5px;">â˜… å·²æ”¶è—</div>
                    <div class="review-q-text">${item.id}. ${item.q}</div>
                    <div>æ­£ç¢ºç­”æ¡ˆï¼š<span class="ans-correct">${item.options[item.a]}</span></div>
                `;
                listDiv.appendChild(card);
            });
        }
    }

    function startTimer() {
        examTimeLeft = 3600;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            examTimeLeft--;
            updateTimerDisplay();
            if (examTimeLeft <= 0) {
                alert("æ™‚é–“åˆ°ï¼è‡ªå‹•äº¤å·ã€‚");
                finishExam();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const min = Math.floor(examTimeLeft / 60);
        const sec = examTimeLeft % 60;
        document.getElementById('timer-badge').textContent = 
            `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }
</script>

</body>
</html>
